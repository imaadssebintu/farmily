<div id="personDetails">
    <!-- Person details will be loaded here -->
</div>

<!-- Edit Person Modal -->
<div id="editPersonModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Person</h2>
            <button onclick="closeEditPersonModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-form">
            <form id="editPersonForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editFirstName">First Name</label>
                        <input type="text" id="editFirstName" required>
                    </div>
                    <div class="form-group">
                        <label for="editMiddleName">Middle Name</label>
                        <input type="text" id="editMiddleName">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editLastName">Last Name</label>
                        <input type="text" id="editLastName" required>
                    </div>
                    <div class="form-group">
                        <label for="editMaidenName">Maiden Name</label>
                        <input type="text" id="editMaidenName">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editGender">Gender</label>
                    <select id="editGender" required>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editBirthDate">Birth Date</label>
                        <input type="date" id="editBirthDate">
                    </div>
                    <div class="form-group">
                        <label for="editBirthPlace">Birth Place</label>
                        <input type="text" id="editBirthPlace">
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editIsLiving" onchange="toggleDeathFields()"> Living
                    </label>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editFather">Father (Optional)</label>
                        <select id="editFather">
                            <option value="">None</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editMother">Mother (Optional)</label>
                        <select id="editMother">
                            <option value="">None</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="deathFields">
                    <div class="form-group">
                        <label for="editDeathDate">Death Date</label>
                        <input type="date" id="editDeathDate">
                    </div>
                    <div class="form-group">
                        <label for="editDeathPlace">Death Place</label>
                        <input type="text" id="editDeathPlace">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editOccupation">Occupation</label>
                    <input type="text" id="editOccupation">
                </div>
                <div class="form-group">
                    <label for="editBiography">Biography</label>
                    <textarea id="editBiography" rows="4"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button onclick="closeEditPersonModal()" class="btn-secondary">Cancel</button>
            <button onclick="savePerson()" class="btn-primary">Save Changes</button>
        </div>
    </div>
</div>

<!-- Add Relationship Modal -->
<div id="addRelationshipModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Relationship</h2>
            <button onclick="closeAddRelationshipModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-form">
            <form id="addRelationshipForm">
                <div class="form-group">
                    <label for="relatedPerson">Related Person</label>
                    <select id="relatedPerson" required>
                        <option value="">Select a person...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="relationshipType" id="relationshipTypeLabel">Relationship Type</label>
                    <select id="relationshipType" required>
                        <option value="parent">Parent</option>
                        <option value="child">Child</option>
                        <option value="spouse">Spouse</option>
                        <option value="sibling">Sibling</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="startDate">Start Date (Optional)</label>
                    <input type="date" id="startDate">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button onclick="closeAddRelationshipModal()" class="btn-secondary">Cancel</button>
            <button onclick="saveRelationship()" class="btn-primary">Save</button>
        </div>
    </div>
</div>

<script>
    const personId = '{{.PersonID}}';
    let currentPersonData = null;
    let currentPersonRelationships = [];

    async function loadPersonDetails() {
        try {
            const response = await fetch(`/api/people/${personId}`);
            const data = await response.json();

            if (data.success) {
                displayPersonDetails(data.data);
                loadRelationships();
            }
        } catch (error) {
            console.error('Failed to load person details:', error);
        }
    }

    function displayPersonDetails(person) {
        currentPersonData = person;
        const detailsContainer = document.getElementById('personDetails');

        detailsContainer.innerHTML = `
            <div class="page-header">
                <div>
                    <h1 class="page-title">${person.display_name}</h1>
                    <p class="page-subtitle">${person.lifespan}</p>
                </div>
                <div class="header-actions">
                    <button onclick="editPerson()" class="btn-secondary">Edit</button>
                    <button onclick="deletePerson()" class="btn-danger">Delete</button>
                </div>
            </div>

            <div class="person-detail-grid">
                <div class="detail-section">
                    <h2 class="section-title">Personal Information</h2>
                    <div class="detail-card">
                        <div class="detail-row">
                            <span class="detail-label">Full Name:</span>
                            <span class="detail-value">${person.display_name}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Gender:</span>
                            <span class="detail-value">${person.gender}</span>
                        </div>
                        ${person.birth_date ? `
                        <div class="detail-row">
                            <span class="detail-label">Birth Date:</span>
                            <span class="detail-value">${new Date(person.birth_date).toLocaleDateString()}</span>
                        </div>
                        ` : ''}
                        ${person.birth_place ? `
                        <div class="detail-row">
                            <span class="detail-label">Birth Place:</span>
                            <span class="detail-value">${person.birth_place}</span>
                        </div>
                        ` : ''}
                        ${person.death_date ? `
                        <div class="detail-row">
                            <span class="detail-label">Death Date:</span>
                            <span class="detail-value">${new Date(person.death_date).toLocaleDateString()}</span>
                        </div>
                        ` : ''}
                        ${person.death_place ? `
                        <div class="detail-row">
                            <span class="detail-label">Death Place:</span>
                            <span class="detail-value">${person.death_place}</span>
                        </div>
                        ` : ''}
                        ${person.occupation ? `
                        <div class="detail-row">
                            <span class="detail-label">Occupation:</span>
                            <span class="detail-value">${person.occupation}</span>
                        </div>
                        ` : ''}
                        ${person.age !== null ? `
                        <div class="detail-row">
                            <span class="detail-label">Age:</span>
                            <span class="detail-value">${person.age} years</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${person.biography ? `
                    <div class="detail-card">
                        <h3 class="subsection-title">Biography</h3>
                        <p class="biography-text">${person.biography}</p>
                    </div>
                    ` : ''}
                </div>

                <div class="detail-section">
                    <div class="section-header">
                        <h2 class="section-title">Relationships</h2>
                        <button onclick="showAddRelationshipModal()" class="btn-small">+ Add</button>
                    </div>
                    <div id="relationshipsList" class="relationships-list">
                        <!-- Relationships will be loaded here -->
                    </div>
                </div>
            </div>
        `;
    }

    async function loadRelationships() {
        try {
            const response = await fetch(`/api/people/${personId}/relationships`);
            const data = await response.json();

            if (data.success) {
                currentPersonRelationships = data.data || [];
                displayRelationships(currentPersonRelationships);
            }
        } catch (error) {
            console.error('Failed to load relationships:', error);
        }
    }

    function displayRelationships(relationships) {
        const relationshipsList = document.getElementById('relationshipsList');

        if (relationships.length === 0) {
            relationshipsList.innerHTML = '<p class="empty-state-small">No relationships added yet.</p>';
            return;
        }

        relationshipsList.innerHTML = relationships.map(rel => {
            const otherPerson = rel.person1_id === personId ? rel.person2_name : rel.person1_name;
            const relType = rel.relationship_type;

            return `
                <div class="relationship-item">
                    <div class="relationship-info">
                        <span class="relationship-type">${relType}</span>
                        <span class="relationship-name">${otherPerson}</span>
                    </div>
                    <button onclick="deleteRelationship('${rel.id}')" class="btn-icon">üóëÔ∏è</button>
                </div>
            `;
        }).join('');
    }

    async function deletePerson() {
        if (!confirm('Are you sure you want to delete this person? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/people/${personId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                window.location.href = '/people';
            } else {
                alert('Failed to delete person: ' + data.message);
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
        }
    }

    function editPerson() {
        if (!currentPersonData) return;

        // Populate fields
        document.getElementById('editFirstName').value = currentPersonData.first_name || '';
        document.getElementById('editMiddleName').value = currentPersonData.middle_name || '';
        document.getElementById('editLastName').value = currentPersonData.last_name || '';
        document.getElementById('editMaidenName').value = currentPersonData.maiden_name || '';
        document.getElementById('editGender').value = currentPersonData.gender || 'Male';

        // Handle dates (format YYYY-MM-DD from timestamp)
        if (currentPersonData.birth_date) {
            document.getElementById('editBirthDate').value = currentPersonData.birth_date.split('T')[0];
        } else {
            document.getElementById('editBirthDate').value = '';
        }

        document.getElementById('editBirthPlace').value = currentPersonData.birth_place || '';
        document.getElementById('editIsLiving').checked = currentPersonData.is_living;

        if (currentPersonData.death_date) {
            document.getElementById('editDeathDate').value = currentPersonData.death_date.split('T')[0];
        } else {
            document.getElementById('editDeathDate').value = '';
        }

        document.getElementById('editDeathPlace').value = currentPersonData.death_place || '';
        document.getElementById('editOccupation').value = currentPersonData.occupation || '';
        document.getElementById('editBiography').value = currentPersonData.biography || '';

        // Populate and pre-select parents
        populateEditParents();

        toggleDeathFields();
        document.getElementById('editPersonModal').style.display = 'flex';
    }

    async function populateEditParents() {
        const fatherSelect = document.getElementById('editFather');
        const motherSelect = document.getElementById('editMother');

        fatherSelect.innerHTML = '<option value="">None</option>';
        motherSelect.innerHTML = '<option value="">None</option>';

        try {
            const response = await fetch('/api/people');
            const data = await response.json();

            if (data.success) {
                // Find current father and mother IDs from relationships
                // RelationshipType 'parent' means the OTHER person is the parent
                const currentFather = currentPersonRelationships.find(r => {
                    if (r.relationship_type !== 'parent') return false;
                    const otherGender = r.person1_id === personId ? r.person2_gender : r.person1_gender;
                    return otherGender === 'Male';
                });

                const currentMother = currentPersonRelationships.find(r => {
                    if (r.relationship_type !== 'parent') return false;
                    const otherGender = r.person1_id === personId ? r.person2_gender : r.person1_gender;
                    return otherGender === 'Female';
                });

                const fatherID = currentFather ? (currentFather.person1_id === personId ? currentFather.person2_id : currentFather.person1_id) : '';
                const motherID = currentMother ? (currentMother.person1_id === personId ? currentMother.person2_id : currentMother.person1_id) : '';

                data.data.forEach(p => {
                    if (p.id === personId) return; // Don't list self

                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.display_name} (${p.lifespan})`;

                    if (p.gender === 'Male') {
                        fatherSelect.appendChild(option);
                    } else if (p.gender === 'Female') {
                        motherSelect.appendChild(option);
                    }
                });

                fatherSelect.value = fatherID;
                motherSelect.value = motherID;
            }
        } catch (error) {
            console.error('Failed to populate parents:', error);
        }
    }

    function closeEditPersonModal() {
        document.getElementById('editPersonModal').style.display = 'none';
    }

    function toggleDeathFields() {
        const isLiving = document.getElementById('editIsLiving').checked;
        const deathFields = document.getElementById('deathFields');
        if (isLiving) {
            deathFields.style.opacity = '0.5';
            deathFields.style.pointerEvents = 'none';
        } else {
            deathFields.style.opacity = '1';
            deathFields.style.pointerEvents = 'auto';
        }
    }

    async function savePerson() {
        const data = {
            first_name: document.getElementById('editFirstName').value,
            middle_name: document.getElementById('editMiddleName').value || null,
            last_name: document.getElementById('editLastName').value,
            maiden_name: document.getElementById('editMaidenName').value || null,
            gender: document.getElementById('editGender').value,
            birth_date: document.getElementById('editBirthDate').value || null,
            birth_place: document.getElementById('editBirthPlace').value || null,
            is_living: document.getElementById('editIsLiving').checked,
            death_date: document.getElementById('editDeathDate').value || null,
            death_place: document.getElementById('editDeathPlace').value || null,
            occupation: document.getElementById('editOccupation').value || null,
            biography: document.getElementById('editBiography').value || null,
            father_id: document.getElementById('editFather').value || null,
            mother_id: document.getElementById('editMother').value || null
        };

        if (!data.first_name || !data.last_name) {
            alert('First Name and Last Name are required.');
            return;
        }

        try {
            const response = await fetch(`/api/people/${personId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                closeEditPersonModal();
                loadPersonDetails(); // Reload to show new data
            } else {
                alert('Failed to update person: ' + result.message);
            }
        } catch (error) {
            console.error('Error updating person:', error);
            alert('An error occurred while saving.');
        }
    }

    async function showAddRelationshipModal() {
        const modal = document.getElementById('addRelationshipModal');
        const select = document.getElementById('relatedPerson');

        // Update label to clarify direction
        const label = document.getElementById('relationshipTypeLabel');
        if (label && currentPersonData) {
            label.innerText = `is the ... of ${currentPersonData.display_name}`;
        }

        // Show modal immediately
        modal.style.display = 'flex';

        // Fetch people to populate dropdown
        try {
            const response = await fetch('/api/people');
            const data = await response.json();

            if (data.success) {
                // Clear existing options except default
                select.innerHTML = '<option value="">Select a person...</option>';

                // Add people (excluding current person)
                data.data.forEach(p => {
                    if (p.id !== personId) {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.display_name;
                        select.appendChild(option);
                    }
                });
            }
        } catch (error) {
            console.error('Failed to load people:', error);
            alert('Failed to load people list');
        }
    }

    function closeAddRelationshipModal() {
        document.getElementById('addRelationshipModal').style.display = 'none';
        document.getElementById('addRelationshipForm').reset();
    }

    async function saveRelationship() {
        const otherPersonId = document.getElementById('relatedPerson').value;
        const type = document.getElementById('relationshipType').value;
        const startDate = document.getElementById('startDate').value;

        if (!otherPersonId) {
            alert('Please select a person');
            return;
        }

        try {
            const response = await fetch('/api/relationships', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    person1_id: personId,
                    person2_id: otherPersonId,
                    relationship_type: type,
                    start_date: startDate || undefined
                })
            });

            const data = await response.json();

            if (data.success) {
                closeAddRelationshipModal();
                loadRelationships();
            } else {
                alert('Failed to create relationship: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while saving the relationship');
        }
    }

    async function deleteRelationship(relationshipId) {
        if (!confirm('Are you sure you want to delete this relationship?')) {
            return;
        }

        try {
            const response = await fetch(`/api/relationships/${relationshipId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                loadRelationships();
            } else {
                alert('Failed to delete relationship: ' + data.message);
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
        }
    }

    // Load person details on page load
    loadPersonDetails();
</script>