<div class="page-header">
    <div>
        <h1 class="page-title">Family Tree</h1>
        <p class="page-subtitle">Visualize your family history</p>
    </div>
</div>

<div class="tree-container" id="treeContainer">
    <!-- SVG will be injected here -->
</div>

<style>
    .tree-container {
        width: 100%;
        height: calc(100vh - 200px);
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 1rem;
        overflow: hidden;
        position: relative;
    }

    .node circle {
        stroke: #fff;
        stroke-width: 2px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .node:hover circle {
        stroke: var(--primary-color);
        stroke-width: 3px;
        filter: drop-shadow(0 0 5px var(--primary-color));
    }

    .node text {
        font-family: 'Inter', sans-serif;
        font-size: 12px;
        fill: var(--text-primary);
        pointer-events: none;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
    }

    .link {
        stroke: var(--border-color);
        stroke-opacity: 0.6;
        stroke-width: 1.5px;
    }

    .node image {
        cursor: pointer;
    }
</style>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    async function initTree() {
        const container = document.getElementById('treeContainer');
        const width = container.clientWidth;
        const height = container.clientHeight;

        try {
            const response = await fetch('/api/tree/data');
            const result = await response.json();

            if (!result.success) {
                console.error('Failed to load tree data:', result.message);
                return;
            }

            const data = result.data;

            // Level Calculation for Hierarchical Layout
            const nodeMap = new Map(data.nodes.map(n => [n.id, n]));
            data.nodes.forEach(n => n.level = 0);

            // Propagate levels based on relationships
            // Run multiple passes to ensure depth propagation
            for (let i = 0; i < data.nodes.length; i++) {
                data.links.forEach(link => {
                    const source = nodeMap.get(link.source);
                    const target = nodeMap.get(link.target);

                    if (source && target) {
                        if (link.type === 'parent') {
                            // Source is Parent of Target -> Target is lower (higher level)
                            if (target.level <= source.level) target.level = source.level + 1;
                        } else if (link.type === 'child') {
                            // Source is Child of Target -> Source is lower (higher level)
                            if (source.level <= target.level) source.level = target.level + 1;
                        }
                    }
                });
            }

            // D3 Implementation
            const svg = d3.select("#treeContainer")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .call(d3.zoom().on("zoom", (event) => {
                    g.attr("transform", event.transform);
                }));

            const g = svg.append("g");

            const simulation = d3.forceSimulation(data.nodes)
                .force("link", d3.forceLink(data.links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-500))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collide", d3.forceCollide().radius(50))
                .force("y", d3.forceY(d => d.level * 100).strength(0.5));

            const link = g.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(data.links)
                .enter().append("line")
                .attr("class", "link");

            const node = g.append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(data.nodes)
                .enter().append("g")
                .attr("class", "node")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            // Node circles (gender-based color)
            node.append("circle")
                .attr("r", 20)
                .attr("fill", d => {
                    if (d.gender === 'Male') return '#3b82f6'; // Blue
                    if (d.gender === 'Female') return '#ec4899'; // Pink
                    return '#10b981'; // Green for others
                });

            // Node labels
            node.append("text")
                .attr("dy", 32)
                .attr("text-anchor", "middle")
                .text(d => d.name);

            // Click to view person details
            node.on("click", (event, d) => {
                window.location.href = `/people/${d.id}`;
            });

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);
            });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

        } catch (error) {
            console.error('Error initializing tree:', error);
        }
    }

    // Handle window resize
    window.addEventListener('resize', () => {
        d3.select("#treeContainer svg").remove();
        initTree();
    });

    initTree();
</script>